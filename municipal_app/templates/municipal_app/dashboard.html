{% extends 'base.html' %}

{% block title %}Contabot{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <h2 class="mb-4">Bienvenido, {{ user.username }}</h2>

      <p>Esta es tu página de inicio. Desde aquí puedes acceder a las diferentes funcionalidades de la aplicación.</p>

      {% if not has_municipal_credentials %}
        <div class="alert alert-warning" role="alert">
          Aún no has ingresado tus credenciales de la municipalidad. Por favor, <a href="{% url 'municipal_credentials' %}" class="alert-link">ingrésalas aquí</a> para utilizar todas las funcionalidades.
        </div>
      {% endif %}

      {% if not has_misiones_credentials %}
        <div class="alert alert-danger" role="alert">
          Aún no has ingresado tus credenciales de Renta Misiones. Por favor, <a href="{% url 'misiones_credentials' %}" class="alert-link">ingrésalas aquí</a> para utilizar todas las funcionalidades.
        </div>
      {% endif %}

      <div class="list-group">
       <div class="d-grid gap-2 mb-4"> {# d-grid para botón de ancho completo, gap-2 para espacio, mb-4 para margen inferior #}
         <a href="{% url 'enter_billing' %}" class="btn btn-primary btn-lg">
           Ingresar Facturación Mensual
         </a>
       </div>
       <div class="d-grid gap-2 mb-4">
         <a href="{% url 'enter_misiones' %}" class="btn btn-danger btn-lg">
           Ingresar Renta Misiones
         </a>
       </div>
       <a href="{% url 'history' %}" class="list-group-item list-group-item-action">
         <i class="bi bi-clock-history"></i> Ver Historial de Ejecuciones
       </a>
       <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">
         Ver y Editar Perfil
       </a>
       <a href="{% url 'municipal_credentials' %}" class="list-group-item list-group-item-action">
         Gestionar Credenciales de la Municipalidad
       </a>
       <a href="{% url 'misiones_credentials' %}" class="list-group-item list-group-item-action">
         Gestionar Credenciales de Renta Misiones
       </a>
       <a href="{% url 'chatbot' %}" class="list-group-item list-group-item-action">
         <i class="bi bi-robot"></i> Consultar Chatbot
       </a>
     </div>

     <div class="mt-4">
       <h4>Consulta Rápida al Chatbot</h4>
       <p class="text-muted">Haz una pregunta rápida sobre normativas o trámites.</p>
       <div class="card">
         <div class="card-body">
           <form id="quick-chat-form">
             {% csrf_token %}
             <div class="input-group">
               <input type="text" class="form-control" id="quick-pregunta" name="pregunta" placeholder="Escribe tu pregunta..." required>
               <button type="submit" class="btn btn-outline-primary" id="quick-submit-btn">
                 <i class="bi bi-search"></i>
               </button>
             </div>
           </form>
           <div id="quick-response" class="mt-2" style="display: none;">
             <div class="alert alert-info">
               <strong>Respuesta:</strong> <span id="response-text"></span>
             </div>
           </div>
         </div>
       </div>
     </div>

   </div>
 </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
   const quickForm = document.getElementById('quick-chat-form');
   const responseDiv = document.getElementById('quick-response');
   const responseText = document.getElementById('response-text');
   const submitBtn = document.getElementById('quick-submit-btn');

   quickForm.addEventListener('submit', function(e) {
       e.preventDefault();
       const pregunta = document.getElementById('quick-pregunta').value.trim();

       if (!pregunta) return;

       // Disable form while processing
       document.getElementById('quick-pregunta').disabled = true;
       submitBtn.disabled = true;
       submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

       // Send AJAX request
       fetch('/api/chatbot/', {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
           },
           body: JSON.stringify({pregunta: pregunta})
       })
       .then(response => response.json())
       .then(data => {
           if (data.respuesta) {
               responseText.textContent = data.respuesta;
               responseDiv.style.display = 'block';
           } else if (data.error) {
               responseText.textContent = 'Error: ' + data.error;
               responseDiv.style.display = 'block';
           }
       })
       .catch(error => {
           responseText.textContent = 'Error de conexión. Inténtalo de nuevo.';
           responseDiv.style.display = 'block';
           console.error('Error:', error);
       })
       .finally(() => {
           // Re-enable form
           document.getElementById('quick-pregunta').value = '';
           document.getElementById('quick-pregunta').disabled = false;
           submitBtn.disabled = false;
           submitBtn.innerHTML = '<i class="bi bi-search"></i>';
       });
   });
});
</script>
{% endblock %}